<!DOCTYPE html>
<html>
<head>
  <title>Record Audio</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #111;
      color: white;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h3>Audio Recorder</h3>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" style="display:none;">Stop & Upload</button>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let chunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusText = document.getElementById("status");

    // Get the Airtable record ID from the URL (e.g. ?recordId=recXXXXXX)
    const recordId = new URLSearchParams(window.location.search).get("recordId");

    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const base64 = await blobToBase64(blob);

          try {
            const response = await fetch('https://hooks.zapier.com/hooks/catch/21433946/2crc63s/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                recordId: recordId,
                audioBase64: base64,
                fileName: "recording.webm"
              })
            });

            if (response.ok) {
              statusText.textContent = "Uploaded!";
              setTimeout(() => window.close(), 1000);
            } else {
              statusText.textContent = "Upload failed: " + response.statusText;
            }
          } catch (err) {
            statusText.textContent = "Error uploading: " + err;
          }
        };

        mediaRecorder.start();
        statusText.textContent = "Recording...";
        startBtn.style.display = "none";
        stopBtn.style.display = "inline";

      } catch (err) {
        statusText.textContent = "Microphone error: " + err;
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder) {
        mediaRecorder.stop();
        statusText.textContent = "Uploading...";
        stopBtn.style.display = "none";
      }
    };

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64Data = reader.result.split(',')[1];
          resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
