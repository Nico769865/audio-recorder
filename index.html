<!DOCTYPE html>
<html>
<head>
  <title>Record Audio</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h3>Audio Recorder</h3>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" style="display:none;">Stop & Upload</button>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let chunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusText = document.getElementById("status");

    const recordId = new URLSearchParams(window.location.search).get("recordId");

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const base64 = await blobToBase64(blob);

        await fetch('https://hooks.zapier.com/hooks/catch/YOUR-ZAPIER-HOOK-ID/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            recordId: recordId,
            audioBase64: base64,
            fileName: "recording.webm"
          })
        });

        statusText.textContent = "Uploaded!";
        setTimeout(() => window.close(), 1000);
      };

      mediaRecorder.start();
      statusText.textContent = "Recording...";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline";
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      statusText.textContent = "Uploading...";
    };

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
